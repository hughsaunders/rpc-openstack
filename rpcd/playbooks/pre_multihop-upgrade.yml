---
- name: Gather facts
  hosts: shared-infra_hosts[0]

- name: Prep inventory for multihop upgrade
  hosts: localhost
  tasks:
    - name: Map upgrade container to galera host
      copy:
        dest: /etc/openstack_deploy/conf.d/upgrade.yml
        content: |
          ---
          # Copyright 2016, Rackspace US, Inc.
          #
          # Licensed under the Apache License, Version 2.0 (the "License");
          # you may not use this file except in compliance with the License.
          # You may obtain a copy of the License at
          #
          #     http://www.apache.org/licenses/LICENSE-2.0
          #
          # Unless required by applicable law or agreed to in writing, software
          # distributed under the License is distributed on an "AS IS" BASIS,
          # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
          # See the License for the specific language governing permissions and
          # limitations under the License.
          upgrade_hosts:
            {{ groups['shared-infra_hosts'][0] }}:
              ip: {{ hostvars[groups['shared-infra_hosts'][0]]['ansible_default_ipv4']['address'] }}
    - name: Add upgrade container groups
      copy:
        dest: /etc/openstack_deploy/env.d/upgrade.yml
        content: |
          ---
          # Copyright 2016, Rackspace US, Inc.
          #
          # Licensed under the Apache License, Version 2.0 (the "License");
          # you may not use this file except in compliance with the License.
          # You may obtain a copy of the License at
          #
          #     http://www.apache.org/licenses/LICENSE-2.0
          #
          # Unless required by applicable law or agreed to in writing, software
          # distributed under the License is distributed on an "AS IS" BASIS,
          # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
          # See the License for the specific language governing permissions and
          # limitations under the License.

          component_skel:
            upgrade:
              belongs_to:
                - upgrade_all

          container_skel:
            upgrade_container:
              belongs_to:
                - upgrade_containers
              contains:
                - upgrade
              properties:
                service_name: upgrade
                container_release: trusty

          physical_skel:
            upgrade_containers:
              belongs_to:
                - all_containers
            upgrade_hosts:
              belongs_to:
                - hosts

